<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <!-- Tonejs -->
    <script src="https://unpkg.com/tone"></script>
    
    <link href="style.css" rel="stylesheet">
    
    <!-- funzioni audio, fare sparire o usare webjs -->
    <script>
      // server ambiente socket anche per i client
      const socket = io();
  
      var elem = document.documentElement;
  
      // VARIABILI TONEJS
      var nois = new Tone.Noise("pink").toDestination();
      var noisInit = 1;
      var nois2 = new Tone.Noise("pink").toDestination();
      var nois2Init = 1;
      var sin = new Tone.Oscillator(440, "sine").toDestination();
      var sinInit = 1;
      var sin2 = new Tone.Oscillator(440, "sine").toDestination();
      var sin2Init = 1;
      var saws = new Tone.Oscillator(440, "sawtooth6").toDestination();
      var sawsInit = 1;
      var saws2 = new Tone.Oscillator(440, "sawtooth6").toDestination();
      var saws2Init = 1;
      var player = new Tone.Player("sound-1.wav").toMaster();
      var playerInit = 1;
  
      // TENTATIVI METRONOMO
      let intervalIdMetro, noise, envelope;
  
      function getRandomInt(number) {
        min = Math.ceil(-number);
        max = Math.floor(number);
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
  
      // funzione tone js crea nota
      function pinkNoiseEdit(args) {
        if (noisInit == 1) {
          nois.volume.value = -Infinity; // Set initial volume to -Infinity
          noisInit = 0;
          nois.start();
          nois.volume.rampTo(args[0], args[1] / 1000);
        }
        nois.start();
        nois.volume.rampTo(args[0], args[1] / 1000);
      }
  
      // funzione tone js crea nota
      function sineEdit(args) {
        if (sinInit == 1) {
          sin.volume.value = -Infinity; // Set initial volume to -Infinity
          sinInit = 0;
          sin.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          sin.start();
          sin.volume.rampTo(args[2], args[3] / 1000);
        }
  
        // attack or release to avoid detunig swith on release
        if (args[2] < -60 || args[2] === "-Infinity") {
          sin.volume.rampTo(args[2], args[3] / 1000);
        } else {
          sin.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          sin.start();
          sin.volume.rampTo(args[2], args[3] / 1000);
        }
      }
  
      // funzione tone js crea nota
      function sawEdit(args) {
        if (sawsInit == 1) {
          saws.volume.value = -Infinity; // Set initial volume to -Infinity
          sawsInit = 0;
          saws.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          saws.start();
          saws.volume.rampTo(args[2], args[3] / 1000);
        }
  
        // attack or release to avoid detunig swith on release
        if (args[2] < -60 || args[2] === "-Infinity") {
          saws.volume.rampTo(args[2], args[3] / 1000);
        } else {
          saws.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          saws.start();
          saws.volume.rampTo(args[2], args[3] / 1000);
        }
      }
  
      // funzione tone js crea nota
      function pinkNoiseEdit2(args) {
        if (nois2Init == 1) {
          nois2.volume.value = -Infinity; // Set initial volume to -Infinity
          nois2Init = 0;
          nois2.start();
          nois2.volume.rampTo(args[0], args[1] / 1000);
        }
        nois2.start();
        nois2.volume.rampTo(args[0], args[1] / 1000);
      }
      // funzione tone js crea nota
      function sineEdit2(args) {
        if (sin2Init == 1) {
          sin2.volume.value = -Infinity; // Set initial volume to -Infinity
          sin2Init = 0;
          sin2.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          sin2.start();
          sin2.volume.rampTo(args[2], args[3] / 1000);
        }
  
        // attack or release to avoid detunig swith on release
        if (args[2] < -60 || args[2] === "-Infinity") {
          sin2.volume.rampTo(args[2], args[3] / 1000);
        } else {
          sin2.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          sin2.start();
          sin2.volume.rampTo(args[2], args[3] / 1000);
        }
      }
  
      // funzione tone js crea nota
      function sawEdit2(args) {
        if (saws2Init == 1) {
          saws2.volume.value = -Infinity; // Set initial volume to -Infinity
          saws2Init = 0;
          saws2.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          saws2.start();
          saws2.volume.rampTo(args[2], args[3] / 1000);
        }
  
        // attack or release to avoid detunig swith on release
        if (args[2] < -60 || args[2] === "-Infinity") {
          saws2.volume.rampTo(args[2], args[3] / 1000);
        } else {
          saws2.frequency.value = Number(args[0]) + getRandomInt(args[1]);
          saws2.start();
          saws2.volume.rampTo(args[2], args[3] / 1000);
        }
      }
  
      // AudioPlayer
      function audioPlayerEdit(args) {
        let text1 = "sound-";
        let text2 = ".wav";
        let file = text1.concat(args[0], text2);
  
        // If a player instance exists, stop and dispose it
        if (player) {
          player.stop();
          player.dispose();
        }
  
        // Create a new player instance without autostart
        player = new Tone.Player({
          url: file,
          autostart: false, // Autostart is false to wait for onload
          loop: Number(args[2]),
          onload: function () {
            // Start playback after the player has loaded the audio
            player.start();
            // Set the volume
            player.volume.rampTo(args[1], 0.5);
          },
        }).toDestination();
      }
  
      // Function to start the metronome
      function metroEdit(args, action = "start") {
        const volumeDb = args[0]; // Volume in dB
        const intervalMs = args[1]; // Interval in milliseconds
  
        // Function to stop and dispose of noise and envelope
        const stopAndDispose = () => {
          if (intervalIdMetro) {
            clearInterval(intervalIdMetro);
            intervalIdMetro = null;
          }
          if (noise) {
            noise.stop();
            noise.dispose();
            noise = null;
          }
          if (envelope) {
            envelope.dispose();
            envelope = null;
          }
        };
  
        if (action === "stop") {
          // If action is stop, clean up and exit
          stopAndDispose();
          return;
        }
  
        // Clean up any existing noise or intervals
        stopAndDispose();
  
        // Resume the audio context if it's suspended
        Tone.start();
  
        // Create a new noise source
        noise = new Tone.Noise("white").start();
  
        // Create a gain node to control volume
        const gain = new Tone.Gain(Tone.dbToGain(volumeDb)).toDestination();
  
        // Create an envelope to control the noise
        envelope = new Tone.AmplitudeEnvelope({
          attack: 0.05, // Attack time
          decay: 0.05, // Decay time (50 ms)
          sustain: 0,
          release: 0,
        }).connect(gain);
  
        // Connect the noise source to the envelope
        noise.connect(envelope);
  
        // Trigger the first sound immediately
        envelope.triggerAttackRelease(0.5);
  
        // Play the noise signal at the defined interval
        intervalIdMetro = setInterval(() => {
          envelope.triggerAttackRelease(0.5); // Trigger the envelope
        }, intervalMs);
      }
  
      // FUNZIONI GRAFICHE
      // rimuove bottone
      function removeButton() {
        var button = document.getElementById("hideButton");
        button.remove();
        //create a synth and connect it to the main output (your speakers)
        const debug = new Tone.Synth().toDestination();
  
        //play a middle 'C' for the duration of an 8th note
        debug.triggerAttackRelease("C4", "16n");
  
        if (elem.requestFullscreen) {
          elem.requestFullscreen();
        } else if (elem.webkitRequestFullscreen) {
          /* Safari */
          elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
          /* IE11 */
          elem.msRequestFullscreen();
        }
      }
  
      // COLORI RGB
      function initRGBEdit(args) {
        const targetColor = args.slice(0, 3);
        const durationMs = args[4];
        const startColor = window.getComputedStyle(document.body).backgroundColor;
        const startRgba = startColor.match(/\d+/g).map(Number); // Extract RGB values
  
        const targetRgba = targetColor.map(Number); // Target RGBA values
  
        const startTime = performance.now();
  
        function updateColor(timestamp) {
          const elapsedMs = timestamp - startTime;
          if (elapsedMs >= durationMs) {
            document.body.style.backgroundColor = `rgba(${targetRgba.join(", ")})`;
            return;
          }
  
          const progress = elapsedMs / durationMs;
          const interpolatedRgba = startRgba.map((startVal, i) =>
            Math.round(startVal + (targetRgba[i] - startVal) * progress)
          );
  
          document.body.style.backgroundColor = `rgba(${interpolatedRgba.join(
            ", "
          )})`;
  
          requestAnimationFrame(updateColor);
        }
  
        requestAnimationFrame(updateColor);
      }
  
      // STROBO
      let intervalIdStrobe; // Store the interval ID outside the function
  
      function strobeEdit(args) {
        let swapColor = 0;
        const getRandomColor = () => {
          const r = args[0];
          const g = args[1];
          const b = args[2];
          swapColor = 1 - swapColor;
          return `rgba(${r * swapColor}, ${g * swapColor}, ${b * swapColor}, 1)`;
        };
  
        if (args[3] > 0) {
          clearInterval(intervalIdStrobe); // Clear any existing interval before starting a new one
          intervalIdStrobe = setInterval(() => {
            const newColor = getRandomColor();
            document.getElementById("superDiv").style.backgroundColor = newColor;
          }, args[3]);
        } else {
          clearInterval(intervalIdStrobe);
           // Stop the interval if ms is not positive
        }
      }
  
      // MESSAGGI SOCKET IO
      socket.on("pink", (ctrlValue) => {
        pinkNoiseEdit(ctrlValue);
      });
  
      socket.on("sine", (ctrlValue) => {
        sineEdit(ctrlValue);
      });
  
      socket.on("saw", (ctrlValue) => {
        sawEdit(ctrlValue);
      });
  
      socket.on("pink2", (ctrlValue) => {
        pinkNoiseEdit2(ctrlValue);
      });
  
      socket.on("sine2", (ctrlValue) => {
        sineEdit2(ctrlValue);
      });
  
      socket.on("saw2", (ctrlValue) => {
        sawEdit2(ctrlValue);
      });
  
      socket.on("audioPlayer", (ctrlValue) => {
        audioPlayerEdit(ctrlValue);
      });
  
      socket.on("initRGB", (ctrlValue) => {
        initRGBEdit(ctrlValue);
      });
  
      socket.on("strobe", (ctrlValue) => {
        strobeEdit(ctrlValue);
      });
  
      socket.on("metro", (ctrlValue) => {
        metroEdit(ctrlValue);
      });
  
    </script>

    <title>The Black Cube</title>
  </head>
  <body class="relative">


    <!-- <div id="app"></div> -->
    <div id="text-container"></div>

    
    <!-- <div id="face-recognition" class="">
      <h2>Demo: Webcam continuous face landmarks detection</h2>
      <p>Hold your face in front of your webcam to get real-time face landmarker detection.</br>Click <b>enable webcam</b> below and grant access to the webcam if prompted.</p>
      <div id="liveView" class="videoView">
        <button id="webcamButton" class="mdc-button mdc-button--raised">
          <span class="mdc-button__ripple"></span>
          <span class="mdc-button__label">ENABLE WEBCAM</span>
        </button>
        <div style="position: relative;">
          <video id="webcam" class="hidden" autoplay playsinline></video>
          <canvas class="output_canvas" id="output_canvas"></canvas>
        </div>
      </div>
      <div class="blend-shapes">
        <ul class="blend-shapes-list" id="video-blend-shapes"></ul>
      </div>
    </div> -->







    
    <!-- <div id="hideButton" class="d-flex flex-column p-3">
      <div class="text-center">
        <h2 class="mt-2 card-title">WEB BOX</h2>
        <h4>Surveillance and Manipulation in the Digital Age</h4>
        <br />
        <h4>
          Trans-interactive installation for physical and web environments
        </h4>
 
        <p class="mt-5">
          <em>~</em> Connect with the physical environment by zooming, scrolling
          and exploring virtual space.
        </p>
        <br />
        <p>
          <em>~</em> Turn up the volume and activate the phone ringer for the
          full experience.
        </p>
        <button id="startButton" class="btn btn-dark mt-2 ">START</button>
        <br />
        <br />
        <br />
        <p>
          Lorenzo Ballerini <br />with<br />
          Giuseppe Ernandez & Massimo Reina
        </p>
      </div>
    </div> -->
    <!-- <script type="module" src="main.js"></script> -->
    <!-- <script type="module" src="space.js"></script> -->

    <!-- <script type="module" src="test.js"></script> -->
    <!-- <script type="module" src="main.js"></script> -->
    <script type="module" src="js/main.js"></script>
    <!-- <script type="module" src="transition.js"></script> -->

    <button id="hideButton" onclick="removeButton()"></button>
  </body>
</html>
